{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Settings</h1>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="proxy-tab" data-bs-toggle="tab" data-bs-target="#proxy" type="button" role="tab" aria-controls="proxy" aria-selected="false">Proxy</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">Security</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="auth-tab" data-bs-toggle="tab" data-bs-target="#auth" type="button" role="tab" aria-controls="auth" aria-selected="false">Authentication</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">Logs</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab" aria-controls="database" aria-selected="false">Database</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="settingsTabsContent">
                        <!-- General Settings Tab -->
                        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                            <h5 class="mb-4">General Settings</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_ip_blacklist" checked>
                                        <label class="form-check-label" for="enable_ip_blacklist">Enable IP Blacklist</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="When enabled, access from IPs in the blacklist will be blocked. Useful for preventing access from known malicious IP addresses."></span>
                                    </div>
                                    <div class="helper-text">Blocks access from blacklisted IP addresses and CIDR ranges.</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_domain_blacklist" checked>
                                        <label class="form-check-label" for="enable_domain_blacklist">Enable Domain Blacklist</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="When enabled, requests to domains in the blacklist will be blocked. Effective for restricting access to unwanted websites."></span>
                                    </div>
                                    <div class="helper-text">Blocks access to blacklisted domains and subdomains.</div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="block_direct_ip" checked>
                                        <label class="form-check-label" for="block_direct_ip">Block Direct IP Access</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="When enabled, blocks requests using direct IP addresses. This can prevent bypassing domain filters and improve security."></span>
                                    </div>
                                    <div class="helper-text">Blocks requests that use raw IP addresses instead of domain names.</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="log_level" class="form-label">Log Level</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Controls the detail level of logs. Debug provides the most information but generates larger log files."></span>
                                        <select class="form-select" id="log_level">
                                            <option value="debug">Debug</option>
                                            <option value="info" selected>Info</option>
                                            <option value="warning">Warning</option>
                                            <option value="error">Error</option>
                                        </select>
                                    </div>
                                    <div class="helper-text">Info is recommended for normal operation, Debug for troubleshooting.</div>
                                </div>
                            </div>
                            
                            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-4">
                                <button id="reset-settings" class="btn btn-outline-secondary">Reset Settings</button>
                                <button id="save-settings" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                        
                        <!-- Proxy Settings Tab -->
                        <div class="tab-pane fade" id="proxy" role="tabpanel" aria-labelledby="proxy-tab">
                            <h5 class="mb-4">Proxy Configuration</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="cache_size" class="form-label">Cache Size (MB)</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Size of the Squid disk cache in megabytes. Larger cache can improve performance but uses more disk space."></span>
                                        <input type="number" class="form-control" id="cache_size" value="1000" min="100" max="10000">
                                    </div>
                                    <div class="helper-text">Default: 1000 MB. Recommended: 500-5000 MB based on disk space.</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max_object_size" class="form-label">Max Object Size (MB)</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Maximum size of individual objects to store in the cache. Affects what content types can be cached."></span>
                                        <input type="number" class="form-control" id="max_object_size" value="50" min="1" max="500">
                                    </div>
                                    <div class="helper-text">Limits size of cacheable objects. Higher values cache more content.</div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_compression">
                                        <label class="form-check-label" for="enable_compression">Enable Compression</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="When enabled, Squid will compress HTTP responses when possible, reducing bandwidth usage."></span>
                                    </div>
                                    <div class="helper-text">Reduces bandwidth usage but increases CPU load.</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="connection_timeout" class="form-label">Connection Timeout (seconds)</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Maximum time Squid waits for a connection to be established. Lower values improve responsiveness but can cause issues with slow servers."></span>
                                        <input type="number" class="form-control" id="connection_timeout" value="30" min="5" max="120">
                                    </div>
                                    <div class="helper-text">Default: 30 seconds. Lower for better responsiveness.</div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="dns_timeout" class="form-label">DNS Timeout (seconds)</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Maximum time Squid waits for DNS lookups to complete. Affects how quickly failed domain lookups are reported."></span>
                                        <input type="number" class="form-control" id="dns_timeout" value="5" min="1" max="30">
                                    </div>
                                    <div class="helper-text">Default: 5 seconds. Too low may cause DNS failures.</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="max_connections" class="form-label">Maximum Connections</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Maximum number of concurrent connections Squid will handle. Higher values support more users but increase resource usage."></span>
                                        <input type="number" class="form-control" id="max_connections" value="100" min="10" max="1000">
                                    </div>
                                    <div class="helper-text">Adjust based on number of users and available system resources.</div>
                                </div>
                            </div>
                            
                            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-4">
                                <button id="reload-proxy" class="btn btn-outline-secondary">Reload Proxy</button>
                                <button id="save-proxy-settings" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                        
                        <!-- Security Settings Tab -->
                        <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
                            <h5 class="mb-4">Security Settings</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_content_filtering">
                                        <label class="form-check-label" for="enable_content_filtering">Enable Content Filtering</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Enables filtering based on content type and file extensions. Useful for blocking potentially harmful files."></span>
                                    </div>
                                    <div class="helper-text">Blocks potentially dangerous file types like executables.</div>
                                    
                                    <div id="file-type-block-container" class="mt-3">
                                        <label for="blocked_file_types" class="form-label">Blocked File Types</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="List of file extensions to block. Use comma-separated values (e.g., exe,bat,js)."></span>
                                        <input type="text" class="form-control" id="blocked_file_types" value="exe,bat,cmd,dll,js">
                                        <div class="helper-text">Common values: exe, bat, js, vbs, ps1, msi</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_https_filtering">
                                        <label class="form-check-label" for="enable_https_filtering">Enable HTTPS Filtering</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Enables SSL/TLS interception to filter HTTPS traffic. Requires deploying a CA certificate to client devices."></span>
                                    </div>
                                    <div class="helper-text">Allows inspecting encrypted traffic but requires certificate installation.</div>
                                    
                                    <div id="download-cert-container" class="mt-3">
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <button id="download-cert-btn" class="btn btn-outline-info">Download CA Certificate</button>
                                                <div class="helper-text mt-2">This certificate must be trusted on all client devices.</div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="card">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h5 class="mb-0">Certificate Content</h5>
                                                        <button id="copy-cert-btn" class="btn btn-sm btn-outline-secondary">
                                                            <i class="fas fa-copy"></i> Copy
                                                        </button>
                                                    </div>
                                                    <div class="card-body">
                                                        <pre id="cert-content" class="bg-light p-3 code-block rounded" style="max-height: 300px; overflow-y: auto;">Loading certificate...</pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_time_restrictions">
                                        <label class="form-check-label" for="enable_time_restrictions">Enable Time Restrictions</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Enables time-based access controls. Useful for limiting proxy usage to specific hours."></span>
                                    </div>
                                    <div class="helper-text">Restrict proxy access to certain hours of the day.</div>
                                    
                                    <div id="time-restriction-container" class="mt-3 row">
                                        <div class="col-6">
                                            <label for="time_restriction_start" class="form-label">Start Time</label>
                                            <input type="time" class="form-control" id="time_restriction_start" value="09:00">
                                        </div>
                                        <div class="col-6">
                                            <label for="time_restriction_end" class="form-label">End Time</label>
                                            <input type="time" class="form-control" id="time_restriction_end" value="17:00">
                                        </div>
                                        <div class="col-12">
                                            <div class="helper-text mt-2">Proxy will only be accessible between these hours.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-4">
                                <button id="scan-security" class="btn btn-outline-warning">Security Scan</button>
                                <button id="save-security-settings" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                        
                        <!-- Authentication Tab -->
                        <div class="tab-pane fade" id="auth" role="tabpanel" aria-labelledby="auth-tab">
                            <h5 class="mb-4">Authentication Settings</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_proxy_auth">
                                        <label class="form-check-label" for="enable_proxy_auth">Enable Proxy Authentication</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Requires users to authenticate before using the proxy. Essential for user tracking and access control."></span>
                                    </div>
                                    <div class="helper-text">Requires username/password to use the proxy.</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="auth_method" class="form-label">Authentication Method</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="The authentication mechanism to use. Basic is simplest but sends credentials in clear text."></span>
                                        <select class="form-select" id="auth_method">
                                            <option value="basic" selected>Basic</option>
                                            <option value="digest">Digest</option>
                                            <option value="ntlm">NTLM</option>
                                            <option value="negotiate">Negotiate</option>
                                        </select>
                                    </div>
                                    <div class="helper-text">Basic is simplest, Digest/NTLM more secure but complex.</div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="admin_username" class="form-label">Admin Username</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Username for the admin interface login. Default is 'admin'."></span>
                                        <input type="text" class="form-control" id="admin_username" value="admin">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="admin_password" class="form-label">Admin Password</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Password for the admin interface login. Leave empty to keep current password."></span>
                                        <input type="password" class="form-control" id="admin_password" placeholder="Leave blank to keep current">
                                    </div>
                                    <div id="password-feedback" class="mt-2"></div>
                                </div>
                            </div>
                            
                            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-4">
                                <button id="save-auth-settings" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                        
                        <!-- Logs Tab -->
                        <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
                            <h5 class="mb-4">Log Settings</h5>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_extended_logging">
                                        <label class="form-check-label" for="enable_extended_logging">Enable Extended Logging</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Enables more detailed logging including full URLs, user agents, and response times."></span>
                                    </div>
                                    <div class="helper-text">Provides detailed logs but increases log file size significantly.</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="log_retention" class="form-label">Log Retention (days)</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Number of days to keep logs before automatic deletion. Balances disk usage with historical data needs."></span>
                                        <input type="number" class="form-control" id="log_retention" value="30" min="1" max="365">
                                    </div>
                                    <div class="helper-text">Older logs are automatically purged to save disk space.</div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="enable_alerts">
                                        <label class="form-check-label" for="enable_alerts">Enable Security Alerts</label>
                                        <span class="info-badge" data-bs-toggle="tooltip" title="Enables email notifications for security events like blacklist hits or authentication failures."></span>
                                    </div>
                                    <div class="helper-text">Send email alerts for security incidents and errors.</div>
                                </div>
                            </div>
                            
                            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-4">
                                <button id="clear-logs-btn" class="btn btn-outline-danger me-2">Clear All Logs</button>
                                <button id="clear-old-logs-btn" class="btn btn-outline-warning me-2">Clear Old Logs</button>
                                <button id="save-log-settings" class="btn btn-primary">Save Settings</button>
                            </div>
                        </div>
                        
                        <!-- Database Tab -->
                        <div class="tab-pane fade" id="database" role="tabpanel" aria-labelledby="database-tab">
                            <h5 class="mb-4">Database Management</h5>
                            
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-3">Database Statistics</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Database Size:</span>
                                                <span class="fw-bold" id="db-size">Loading...</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Total Records:</span>
                                                <span class="fw-bold" id="db-records">Loading...</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Last Optimization:</span>
                                                <span class="fw-bold" id="last-optimization">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Log Entries:</span>
                                                <span class="fw-bold" id="log-entries">Loading...</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Blacklist Entries:</span>
                                                <span class="fw-bold" id="blacklist-entries">Loading...</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Database Health:</span>
                                                <span class="fw-bold" id="db-health">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid d-md-flex gap-2 justify-content-md-end mt-4">
                                <button id="refresh-db-stats-btn" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-sync-alt me-1"></i> Refresh Stats
                                </button>
                                <button id="optimize-db-btn" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-database me-1"></i> Optimize Database
                                </button>
                                <button id="export-db-btn" class="btn btn-outline-success me-2">
                                    <i class="fas fa-file-export me-1"></i> Export Database
                                </button>
                                <button id="backup-config-btn" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Backup All Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Reset All Settings Confirmation -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">Reset All Settings</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger fw-bold">Warning: This will reset all settings to their default values.</p>
                    <p>This action cannot be undone. It's recommended to backup your configuration first.</p>
                    <div class="d-flex justify-content-end">
                        <button id="backup-config-btn2" class="btn btn-outline-primary me-2">Backup Configuration</button>
                        <button id="reset-all-btn" class="btn btn-danger">Reset All Settings</button>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Maintenance</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-info mr-2" id="reloadConfigBtn"><i class="fas fa-sync-alt"></i> Reload Proxy Configuration</button>
                    <button class="btn btn-warning mr-2" id="clearCacheBtn"><i class="fas fa-broom"></i> Clear Proxy Cache</button>
                    <button class="btn btn-primary mr-2" id="backupConfigBtn"><i class="fas fa-download"></i> Backup Configuration</button>
                    <button class="btn btn-secondary" id="restoreConfigBtnInput" onclick="document.getElementById('restoreConfigFile').click();"><i class="fas fa-upload"></i> Restore Configuration</button>
                    <input type="file" id="restoreConfigFile" style="display: none;" accept=".json">
                    <button class="btn btn-danger ml-2" id="resetDatabaseBtn"><i class="fas fa-bomb"></i> Reset Database</button> <!-- Added Reset Database Button -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ csp_nonce() }}">
    $(document).ready(function() {
        let initialSettings = {};
        let hasUnsavedChanges = false;

        function captureInitialSettings() {
            initialSettings = getCurrentSettingsValues();
            hasUnsavedChanges = false; // Reset on load/re-load
            // console.log("Initial settings captured:", initialSettings);
            updateSaveButtonStates(); // Update button appearance after capturing
        }

        function getCurrentSettingsValues() {
            return {
                // General
                enable_ip_blacklist: $('#enable_ip_blacklist').is(':checked'),
                enable_domain_blacklist: $('#enable_domain_blacklist').is(':checked'),
                block_direct_ip: $('#block_direct_ip').is(':checked'),
                log_level: $('#log_level').val(),
                
                // Proxy
                cache_size: $('#cache_size').val(),
                max_object_size: $('#max_object_size').val(),
                enable_compression: $('#enable_compression').is(':checked'),
                connection_timeout: $('#connection_timeout').val(),
                dns_timeout: $('#dns_timeout').val(),
                max_connections: $('#max_connections').val(),
                
                // Security
                enable_content_filtering: $('#enable_content_filtering').is(':checked'),
                blocked_file_types: $('#blocked_file_types').val(),
                enable_https_filtering: $('#enable_https_filtering').is(':checked'),
                enable_time_restrictions: $('#enable_time_restrictions').is(':checked'),
                time_restriction_start: $('#time_restriction_start').val(),
                time_restriction_end: $('#time_restriction_end').val(),
                
                // Authentication
                enable_proxy_auth: $('#enable_proxy_auth').is(':checked'),
                auth_method: $('#auth_method').val(),
                admin_username: $('#admin_username').val(),
                // admin_password is not captured for unsaved changes comparison
                
                // Logs
                enable_extended_logging: $('#enable_extended_logging').is(':checked'),
                log_retention: $('#log_retention').val(),
                enable_alerts: $('#enable_alerts').is(':checked')
            };
        }

        function updateSaveButtonStates() {
            if (hasUnsavedChanges) {
                $('#save-settings, #save-proxy-settings, #save-security-settings, #save-auth-settings, #save-log-settings').addClass('btn-warning').removeClass('btn-primary').text('Save Changes*');
            } else {
                $('#save-settings, #save-proxy-settings, #save-security-settings, #save-auth-settings, #save-log-settings').removeClass('btn-warning').addClass('btn-primary').text('Save Settings');
            }
        }

        function checkForUnsavedChanges() {
            const currentSettings = getCurrentSettingsValues();
            hasUnsavedChanges = JSON.stringify(initialSettings) !== JSON.stringify(currentSettings);
            // console.log("Unsaved changes:", hasUnsavedChanges, "Current:", currentSettings, "Initial:", initialSettings);
            updateSaveButtonStates();
        }

        // Load current settings and capture initial state
        loadSettings(captureInitialSettings); 
        
        // Attach change listeners to all relevant input fields
        $('#settingsTabsContent input[type="text"], #settingsTabsContent input[type="number"], #settingsTabsContent input[type="time"], #settingsTabsContent select, #settingsTabsContent textarea').on('input change', checkForUnsavedChanges);
        $('#settingsTabsContent input[type="checkbox"], #settingsTabsContent input[type="radio"]').on('change', checkForUnsavedChanges);

        // Save settings buttons
        $('#save-settings, #save-proxy-settings, #save-security-settings, #save-auth-settings, #save-log-settings').click(function() {
            saveSettings(true); 
        });
        
        // Reset settings (General Tab)
        $('#reset-settings').click(function() {
            if (confirm('Are you sure you want to reset general settings to their defaults?')) {
                resetSettings(); 
            }
        });
        
        // Reset All Settings (Separate Card)
        $('#reset-all-btn').click(function() {
            if (confirm('WARNING: Are you absolutely sure you want to reset ALL settings to factory defaults? This cannot be undone.')) {
                resetAllSettings();
            }
        });

        window.onbeforeunload = function() {
            if (hasUnsavedChanges) {
                return "You have unsaved changes. Are you sure you want to leave?";
            }
        };
        
        // Event handlers for toggles that affect other UI elements
        $('#enable_content_filtering').change(function() {
            $('#file-type-block-container').toggle($(this).is(':checked'));
        });
        
        $('#enable_time_restrictions').change(function() {
            $('#time-restriction-container').toggle($(this).is(':checked'));
        });
        
        $('#enable_https_filtering').change(function() {
            $('#download-cert-container').toggle($(this).is(':checked'));
            if ($(this).is(':checked')) {
                showToast('HTTPS filtering requires installing the CA certificate on all client devices', 'warning');
            }
        });
        
        // Download CA Certificate button functionality is defined in cert-handling.js

        // Database Tab buttons
        loadDatabaseStats(); // Initial load
        
        $('#refresh-db-stats-btn').click(function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...');
            loadDatabaseStats().finally(() => {
                $(this).prop('disabled', false).html('<i class="fas fa-sync-alt me-1"></i> Refresh Stats');
            });
        });
        
        $('#optimize-db-btn').click(function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Optimizing...');
            optimizeDatabase().finally(() => { 
                $(this).prop('disabled', false).html('<i class="fas fa-database me-1"></i> Optimize Database');
            });
        });
        
        $('#export-db-btn').click(function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Exporting...');
            exportDatabase().finally(() => { 
                $(this).prop('disabled', false).html('<i class="fas fa-file-export me-1"></i> Export Database');
            });
        });

        // Log Settings Tab buttons
        $('#clear-logs-btn').click(function() { // Clear All Logs
            if (confirm('Are you sure you want to clear ALL logs? This action cannot be undone.')) {
                clearAllLogs(); 
            }
        });
        
        $('#clear-old-logs-btn').click(function() {
            const daysInput = prompt('Clear logs older than how many days?', '30');
            if (daysInput !== null) {
                const days = parseInt(daysInput);
                if (!isNaN(days) && days > 0) {
                    clearOldLogs(days);
                } else {
                    showToast('Please enter a valid positive number of days.', 'warning');
                }
            }
        });

        // Proxy Settings Tab button
        $('#reload-proxy').click(function() { 
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Reloading...');
            apiRequest('POST', 'maintenance/reload-config')
                .then(function(response) {
                    showToast('Proxy configuration reloaded successfully', 'success');
                })
                .catch(function(error) {
                    showToast('Failed to reload proxy configuration', 'danger');
                })
                .finally(() => {
                    $(this).prop('disabled', false).html('Reload Proxy');
                });
        });
        
        // Security Settings Tab button
        $('#scan-security').click(function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Scanning...');
            apiRequest('POST', 'security/scan')
                .then(function(response) {
                    showToast('Security scan completed', 'success');
                    if (response.data && response.data.recommendations && response.data.recommendations.length > 0) {
                        let message = 'Security recommendations:<br><ul>';
                        response.data.recommendations.forEach(rec => { message += `<li>${rec}</li>`; });
                        message += '</ul>';
                        showToast(message, 'warning', 10000); 
                    } else if (response.data && response.data.recommendations) {
                        showToast('No security issues found!', 'success');
                    }
                })
                .catch(function(error) {
                    showToast('Security scan failed', 'danger');
                })
                .finally(() => {
                    $(this).prop('disabled', false).html('Security Scan');
                });
        });

        // Maintenance Card Buttons
        $('#reloadConfigBtn').click(function() { 
             $(this).prop('disabled', true).html('<i class="fas fa-sync-alt fa-spin"></i> Reloading...');
            apiRequest('POST', 'maintenance/reload-config')
                .then(function(response) {
                    showToast('Proxy configuration reloaded successfully.', 'success');
                })
                .catch(function(error) {
                    showToast('Failed to reload proxy configuration: ' + error.message, 'danger');
                })
                .finally(function() {
                    $(this).prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Reload Proxy Configuration');
                });
        });

        $('#clearCacheBtn').click(function() { 
            if (confirm('Are you sure you want to clear the proxy cache?')) {
                clearCache(); 
            }
        });

        $('#backupConfigBtn, #backup-config-btn, #backup-config-btn2').off('click').on('click', function() { 
            backupConfiguration();
        });
        
        $('#restoreConfigFile').on('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const configData = JSON.parse(e.target.result);
                        if (confirm('Are you sure you want to restore configuration from this file? This will overwrite current settings and reload the proxy.')) {
                            apiRequest('POST', 'maintenance/restore-config', {config: configData})
                                .then(response => {
                                    showToast('Configuration restored successfully. Reloading settings...', 'success');
                                    loadSettings(captureInitialSettings); 
                                    return apiRequest('POST', 'maintenance/reload-config');
                                })
                                .then(() => {
                                    showToast('Proxy configuration reloaded.', 'info');
                                })
                                .catch(err => {
                                    showToast('Failed to restore configuration: ' + (err.message || 'Unknown error'), 'danger');
                                });
                        }
                    } catch (err) {
                        showToast('Invalid configuration file format.', 'danger');
                    } finally {
                        $('#restoreConfigFile').val(''); 
                    }
                };
                reader.readAsText(file);
            }
        });
        
        $('#resetDatabaseBtn').click(function() { 
            if (confirm('DANGER: Are you absolutely sure you want to reset the ENTIRE database? This will delete all logs, blacklists, and user-defined settings, restoring them to factory defaults. This action is IRREVERSIBLE.')) {
                const confirmation = prompt("To confirm, type 'RESET DATABASE' in all caps:");
                if (confirmation === "RESET DATABASE") {
                    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Resetting Database...');
                    apiRequest('POST', 'database/reset')
                        .then(function(response) {
                            showToast('Database reset successfully. Default settings restored. Page will reload.', 'success');
                            setTimeout(() => window.location.reload(), 3000); 
                        })
                        .catch(function(error) {
                            showToast('Failed to reset database: ' + error.message, 'danger');
                             $(this).prop('disabled', false).html('<i class="fas fa-bomb"></i> Reset Database'); // Re-enable on error
                        });
                } else {
                    showToast('Database reset cancelled. Confirmation not matched.', 'info');
                }
            }
        });
        
        $('#admin_password').keyup(function() {
            const password = $(this).val();
            const feedbackEl = $('#password-feedback');
            if (!password) {
                feedbackEl.html('');
                return;
            }
            const validationResults = validatePassword(password);
            if (validationResults.valid) {
                feedbackEl.html('<div class="text-success small"><i class="fas fa-check-circle me-1"></i>Password meets requirements.</div>');
            } else {
                let html = '<div class="text-danger small"><i class="fas fa-exclamation-circle me-1"></i>Password requirements:<ul>';
                validationResults.errors.forEach(error => { html += `<li>${error}</li>`; });
                html += '</ul></div>';
                feedbackEl.html(html);
            }
        });

        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    }); // End of $(document).ready()
    
    function loadSettings(callback) {
        apiRequest('GET', 'settings')
            .then(function(response) {
                if (response.status === 'success') {
                    const settings = {};
                    response.data.forEach(setting => {
                        settings[setting.setting_name] = setting.setting_value;
                    });
                    
                    $('#enable_ip_blacklist').prop('checked', settings.enable_ip_blacklist === 'true');
                    $('#enable_domain_blacklist').prop('checked', settings.enable_domain_blacklist === 'true');
                    $('#block_direct_ip').prop('checked', settings.block_direct_ip === 'true');
                    $('#log_level').val(settings.log_level || 'info');
                    
                    $('#cache_size').val(settings.cache_size || 1000);
                    $('#max_object_size').val(settings.max_object_size || 50);
                    $('#enable_compression').prop('checked', settings.enable_compression === 'true');
                    $('#connection_timeout').val(settings.connection_timeout || 30);
                    $('#dns_timeout').val(settings.dns_timeout || 5);
                    $('#max_connections').val(settings.max_connections || 100);
                    
                    $('#enable_content_filtering').prop('checked', settings.enable_content_filtering === 'true');
                    $('#blocked_file_types').val(settings.blocked_file_types || 'exe,bat,cmd,dll,js');
                    $('#enable_https_filtering').prop('checked', settings.enable_https_filtering === 'true');
                    $('#enable_time_restrictions').prop('checked', settings.enable_time_restrictions === 'true');
                    $('#time_restriction_start').val(settings.time_restriction_start || '09:00');
                    $('#time_restriction_end').val(settings.time_restriction_end || '17:00');
                    
                    $('#enable_proxy_auth').prop('checked', settings.enable_proxy_auth === 'true');
                    $('#auth_method').val(settings.auth_method || 'basic');
                    $('#admin_username').val(settings.admin_username || 'admin');
                    
                    $('#enable_extended_logging').prop('checked', settings.enable_extended_logging === 'true');
                    $('#log_retention').val(settings.log_retention || 30);
                    $('#enable_alerts').prop('checked', settings.enable_alerts === 'true');
                    
                    $('#enable_content_filtering').trigger('change');
                    $('#enable_https_filtering').trigger('change');
                    $('#enable_time_restrictions').trigger('change');
                    
                    if (typeof callback === 'function') {
                        callback(); 
                    }
                } else {
                    showToast(response.message || 'Failed to load settings', 'danger');
                }
            })
            .catch(function(error) {
                showToast('Failed to load settings: ' + (error.message || 'Unknown error'), 'danger');
            });
    }
    
    function saveSettings(isDirectSaveAction = false) {
        const currentSettingsData = getCurrentSettingsValues(); 
        const promises = [];
        
        for (const [name, value] of Object.entries(currentSettingsData)) {
            promises.push(
                apiRequest('PUT', `settings/${name}`, { value: value })
                    .catch(error => {
                        console.error(`Failed to save setting ${name}:`, error);
                        return Promise.reject({settingName: name, error: error}); 
                    })
            );
        }
        
        const newPassword = $('#admin_password').val();
        if (newPassword) {
            const validationResults = validatePassword(newPassword);
            if (!validationResults.valid) {
                showToast('Admin password validation failed: ' + validationResults.errors.join(', '), 'danger');
                $('#password-feedback').html('<div class="text-danger small"><i class="fas fa-exclamation-circle me-1"></i>Password not saved:<ul><li>' + validationResults.errors.join('</li><li>') + '</li></ul></div>');
                return; 
            }
            promises.push(
                apiRequest('PUT', 'settings/admin_password', { value: newPassword })
                    .catch(error => {
                        console.error('Failed to update admin password:', error);
                        return Promise.reject({settingName: 'admin_password', error: error});
                    })
            );
        }
        
        Promise.all(promises)
            .then(() => {
                showToast('Settings saved successfully!', 'success');
                if (newPassword) $('#admin_password').val(''); 
                $('#password-feedback').html(''); 
                
                if (isDirectSaveAction) { 
                    captureInitialSettings(); 
                }
                
                return apiRequest('POST', 'maintenance/reload-config');
            })
            .then(() => {
                showToast('Proxy configuration reloaded.', 'info');
            })
            .catch(rejection => {
                let errorMsg = 'Some settings could not be saved.';
                if (rejection && rejection.settingName) {
                    errorMsg = `Failed to save setting '${rejection.settingName}'.`;
                } else if (rejection && typeof rejection === 'string') {
                    errorMsg = rejection; // If the promise was rejected with a string message
                } else if (rejection && rejection.message) {
                    errorMsg = rejection.message;
                }
                showToast(errorMsg + ' Please check console for details.', 'danger');
                loadSettings(captureInitialSettings); 
            });
    }
    
    function resetSettings() { 
        $('#enable_ip_blacklist').prop('checked', true);
        $('#enable_domain_blacklist').prop('checked', true);
        $('#block_direct_ip').prop('checked', true);
        $('#log_level').val('info');
        
        const generalSettingsToSave = {
            enable_ip_blacklist: $('#enable_ip_blacklist').is(':checked'),
            enable_domain_blacklist: $('#enable_domain_blacklist').is(':checked'),
            block_direct_ip: $('#block_direct_ip').is(':checked'),
            log_level: $('#log_level').val(),
        };
        const promises = [];
        for (const [name, value] of Object.entries(generalSettingsToSave)) {
            promises.push(apiRequest('PUT', `settings/${name}`, { value: value }));
        }
        Promise.all(promises)
            .then(() => {
                showToast('General settings reset to defaults and saved.', 'success');
                captureInitialSettings(); 
                return apiRequest('POST', 'maintenance/reload-config');
            })
            .then(() => showToast('Proxy configuration reloaded.', 'info'))
            .catch(() => {
                showToast('Failed to reset general settings or reload proxy.', 'danger');
                loadSettings(captureInitialSettings); // Refresh from backend
            });
    }

    function resetAllSettings() {
        $('#enable_ip_blacklist').prop('checked', true);
        $('#enable_domain_blacklist').prop('checked', true);
        $('#block_direct_ip').prop('checked', true);
        $('#log_level').val('info');
        $('#cache_size').val('1000'); 
        $('#max_object_size').val('50'); 
        $('#enable_compression').prop('checked', false);
        $('#connection_timeout').val('30');
        $('#dns_timeout').val('5');
        $('#max_connections').val('100');
        $('#enable_content_filtering').prop('checked', false);
        $('#blocked_file_types').val('exe,bat,cmd,dll,js'); 
        $('#enable_https_filtering').prop('checked', false);
        $('#enable_time_restrictions').prop('checked', false);
        $('#time_restriction_start').val('09:00');
        $('#time_restriction_end').val('17:00');
        $('#enable_proxy_auth').prop('checked', false);
        $('#auth_method').val('basic');
        $('#admin_username').val('admin'); 
        $('#enable_extended_logging').prop('checked', false);
        $('#log_retention').val('30'); 
        $('#enable_alerts').prop('checked', false);
        
        $('#enable_content_filtering').trigger('change');
        $('#enable_https_filtering').trigger('change');
        $('#enable_time_restrictions').trigger('change');
        
        try {
            saveSettings(true);
            showToast('All settings reset to defaults. Applying changes...', 'info');
        } catch (error) {
            showToast('Failed to reset settings: ' + (error.message || 'Unknown error'), 'danger');
            loadSettings(captureInitialSettings); // Reload from backend
        } 
    }
    
    function clearCache() {
        apiRequest('POST', 'maintenance/clear-cache')
            .then(function(response) {
                showToast(response.message || 'Cache cleared successfully', 'success');
            })
            .catch(function(error) {
                showToast('Failed to clear cache: ' + (error.message || 'Unknown error'), 'danger');
            });
    }
    
    function backupConfiguration() {
        apiRequest('GET', 'maintenance/backup-config')
            .then(function(response) {
                if (response.status === 'success' && response.data) {
                    const date = new Date().toISOString().slice(0, 10);
                    const filename = `secure-proxy-config-${date}.json`;
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(response.data, null, 2));
                    
                    const downloadLink = document.createElement('a');
                    downloadLink.setAttribute("href", dataStr);
                    downloadLink.setAttribute("download", filename);
                    downloadLink.style.display = "none";
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    
                    showToast('Configuration backup downloaded.', 'success');
                } else {
                     showToast(response.message || 'Failed to retrieve backup data.', 'danger');
                }
            })
            .catch(function(error) {
                showToast('Failed to backup configuration: ' + (error.message || 'Unknown error'), 'danger');
            });
    }
    
    function validatePassword(password) {
        const results = { valid: false, errors: [] };
        if (password.length < 8) results.errors.push('Be at least 8 characters long.');
        if (!/\d/.test(password)) results.errors.push('Contain at least one number.');
        if (!/[a-zA-Z]/.test(password)) results.errors.push('Contain at least one letter.');
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) results.errors.push('Contain at least one special character.');
        results.valid = results.errors.length === 0;
        return results;
    }

    function loadDatabaseStats() {
        return apiRequest('GET', 'database/stats')
            .then(function(response) {
                if (response.status === 'success' && response.data) {
                    const data = response.data;
                    $('#db-size').text(data.db_size || 'N/A');
                    $('#db-records').text(data.total_records || 'N/A');
                    $('#last-optimization').text(data.last_optimization || 'Never');
                    $('#log-entries').text(data.log_entries || 'N/A');
                    $('#blacklist-entries').text(data.blacklist_entries || 'N/A');
                    const healthEl = $('#db-health');
                    healthEl.text(data.health_status || 'Unknown');
                    healthEl.removeClass('text-success text-warning text-danger');
                    if (data.health_status === 'Good') healthEl.addClass('text-success');
                    else if (data.health_status === 'Warning' || data.health_status === 'Needs Optimization') healthEl.addClass('text-warning');
                    else if (data.health_status === 'Error' || data.health_status === 'Critical') healthEl.addClass('text-danger');
                    else healthEl.addClass('text-muted'); // For Unknown or other states
                } else {
                    $('#db-size, #db-records, #last-optimization, #log-entries, #blacklist-entries, #db-health').text('Error loading').addClass('text-danger');
                }
            }).catch(err => {
                showToast('Failed to load database stats: ' + (err.message || 'Unknown error'), 'danger');
                $('#db-size, #db-records, #last-optimization, #log-entries, #blacklist-entries, #db-health').text('Error').addClass('text-danger');
            });
    }

    function optimizeDatabase() { 
        return apiRequest('POST', 'database/optimize')
            .then(res => {
                showToast(res.message || 'Database optimization completed.', 'success');
                loadDatabaseStats(); 
            })
            .catch(err => showToast('Database optimization failed: ' + (err.message || 'Unknown error'), 'danger'));
    }

    function exportDatabase() {
        return apiRequest('GET', 'database/export', null, 'blob') 
            .then(function(blob) { 
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const date = new Date().toISOString().slice(0,10);
                a.download = `secure-proxy-database-backup-${date}.db`; 
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showToast('Database export downloaded.', 'success');
            })
            .catch(err => showToast('Database export failed: ' + (err.message || 'Unknown error'), 'danger'));
    }
    
    function clearAllLogs() { 
        return apiRequest('POST', 'logs/clear') 
            .then(res => {
                showToast(res.message || 'All logs cleared successfully.', 'success');
                loadDatabaseStats(); 
            })
            .catch(err => showToast('Failed to clear all logs: ' + (err.message || 'Unknown error'), 'danger'));
    }

    function clearOldLogs(days) { 
        return apiRequest('POST', 'logs/clear-old', { days: days })
             .then(res => {
                showToast(res.message || `Logs older than ${days} days cleared.`, 'success');
                loadDatabaseStats(); 
             })
            .catch(err => showToast('Failed to clear old logs: ' + (err.message || 'Unknown error'), 'danger'));
    }
</script>
<script src="/static/js/cert-handling.js"></script>
{% endblock %}